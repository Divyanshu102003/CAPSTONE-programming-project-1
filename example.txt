	APP.YAML


runtime: php55
api_version: 1
threadsafe: true

handlers:

- url: /(.+\.php)$
  script: \1

- url: /.*
  script: login.php


	LOGIN.PHP

<?php
session_start();
?>

<html>
<head>
<title>s3589028 - Assignment 1</title>
<link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>

<h1>Login</h1>
<p>
<?php
if ( $_SESSION["loginSucc"]!== False )
{
	echo "User id or password is invalid.<br/>";
}
?>
<br/>
	<form action="login_check.php" method="POST">
	Username: <input type="text" name="username" id="username" maxlength="20" required>
	<br/><br/>
	<!--Password: <input type="password" name="password" id="password">-->
	Password: <input type="text" name="password" id="password" maxlength="20" required>
	<br/><br/>
	<button type="submit">Login</button>
	</form>
<br/>
</p>
</body>
</html>

	LOGIN_CHECK.PHP

<?php
session_start();

//Receive username from client side
$entered_username = $_POST['username'];
//Receive password from client side
$entered_password = $_POST['password'];

require __DIR__ . '/vendor/autoload.php';
use Google\Cloud\Datastore\DatastoreClient;

$projectId = 'cloud-assignment1-part2-272304';
$datastore = new DatastoreClient([
'projectId' => $projectId
]);

$key = $datastore->key('user', $entered_username);
$entity = $datastore->lookup($key);
if (!is_null($entity))
{
	$database_pwd = $entity['password'];
	if (strcmp($database_pwd,$entered_password) === 0)
	{
		$_SESSION["loginSucc"] = False;
			// save name and key for later
		$_SESSION["login_id"] = $entered_username;
		$_SESSION["login_name"] = $entity['name'];
		// password is correct, redirect to main page
		header('Location: main.php');
		exit();
	}
}
$_SESSION["loginSucc"] = True;
header('Location: login.php');

?>

	MAIN.PHP

<?php
session_start();
$_SESSION["nameSucc"] = True;
$_SESSION["passSucc"] = True;
?>

<html>
<head>
<title>s3589028 - Assignment 1</title>
<link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>

<h1>Welcome, <?php echo $_SESSION["login_name"]; ?></h1>
<p>
<a href="/name.php">Change name</a>
<a href="/password.php">Change password</a>
</p>
</body>
</html>

	NAME.PHP


<?php
session_start();
?>

<html>
<head>
<title>s3589028 - Assignment 1</title>
<link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>
<h1>Change name</h1>
<p>

<?php
if ( $_SESSION["nameSucc"] === False )
{
	echo "Error changing name.<br/>";
}
?>

Enter old name and new name.
<br/>
	<form action="name_check.php" method="POST">
	Old name: <input type="text" name="oldname" id="oldname" maxlength="20" required>
	<br/><br/>
	New name: <input type="text" name="newname" id="newname" maxlength="20" required>
	<br/><br/>
	<button type="submit">Change name</button>
	</form>
<br/>
<a href="/main.php">return to main.</a>
</p>
</body>
</html>

	NAME_CHECK.PHP


<?php
session_start();

//Receive username from client side
$oldname = $_POST['oldname'];
//Recieve change username from client side
$newname = $_POST['newname'];

require __DIR__ . '/vendor/autoload.php';
use Google\Cloud\Datastore\DatastoreClient;

$projectId = 'cloud-assignment1-part2-272304';
$datastore = new DatastoreClient([
'projectId' => $projectId
]);

$transaction = $datastore->transaction();
$key = $datastore->key('user', $_SESSION["login_id"]);
$entity = $transaction->lookup($key);

if (!is_null($entity))
{
	if (strcmp($entity['name'],$oldname) === 0)
	{
		$entity['name'] = $newname;
		$_SESSION["login_name"] = $newname;
		$transaction->update($entity);
		$transaction->commit();
		$_SESSION["nameSucc"] = True;
		header('Location: main.php');
		exit();
	}
}
$_SESSION["nameSucc"] = False;
header('Location: name.php');

?>


	PASSWORD.PHP


<?php
session_start();
?>

<html>
<head>
<title>s3589028 - Assignment 1</title>
<link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body>
<h1>Change password</h1>
<p>

<?php
if ( $_SESSION["passSucc"] === False )
{
	echo "Error changing password.<br/>";
}
?>

Enter old password and new password.
<br/>
	<form action="password_check.php" method="POST">
	Old password: <input type="text" name="oldpass" id="oldpass" maxlength="20" required>
	<br/><br/>
	New password: <input type="text" name="newpass" id="newpass" maxlength="20" required>
	<br/><br/>
	<button type="submit">Change password</button>
	</form>
<br/>
<a href="/main.php">return to main.</a>
</p>
</body>
</html>


	PASSWORD_CHECK.PHP


<?php
session_start();

$oldpass = $_POST['oldpass'];
$newpass = $_POST['newpass'];

require __DIR__ . '/vendor/autoload.php';
use Google\Cloud\Datastore\DatastoreClient;

$projectId = 'cloud-assignment1-part2-272304';
$datastore = new DatastoreClient([
'projectId' => $projectId
]);

$transaction = $datastore->transaction();
$key = $datastore->key('user', $_SESSION["login_id"]);
$entity = $transaction->lookup($key);

if (!is_null($entity))
{
	if (strcmp($entity['password'],$oldpass) === 0)
	{
		$entity['password'] = $newpass;
		$_SESSION["login_name"] = $newpass;
		$transaction->update($entity);
		$transaction->commit();
		$_SESSION["passSucc"] = True;
		header('Location: login.php');
		exit();
	}
}

$_SESSION["passSucc"] = False;
header('Location: password.php');

?>
